
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ qwen3-32b-vllm-agg-rr â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ðŸ” DRY-RUN (orchestrator mode)                                                                                                                                                             â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Generated sbatch Script â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚    1 #!/bin/bash                                                                                                                                                                           â”‚
â”‚    2 #SBATCH --job-name=qwen3-32b-vllm-agg-rr                                                                                                                                              â”‚
â”‚    3 #SBATCH --nodes=2                                                                                                                                                                     â”‚
â”‚    4                                                                                                                                                                                       â”‚
â”‚    5 #SBATCH --ntasks=2                                                                                                                                                                    â”‚
â”‚    6 #SBATCH --ntasks-per-node=1                                                                                                                                                           â”‚
â”‚    7                                                                                                                                                                                       â”‚
â”‚    8                                                                                                                                                                                       â”‚
â”‚    9                                                                                                                                                                                       â”‚
â”‚   10                                                                                                                                                                                       â”‚
â”‚   11 #SBATCH --account=coreai_ai-foundation-models_dev                                                                                                                                     â”‚
â”‚   12 #SBATCH --time=04:00:00                                                                                                                                                               â”‚
â”‚   13 #SBATCH --output=/lustre/fsw/coreai_ai-foundation-models_dev/aflowers/srt-slurm/outputs/%j/logs/sweep_%j.log                                                                          â”‚
â”‚   14 #SBATCH --partition=batch                                                                                                                                                             â”‚
â”‚   15                                                                                                                                                                                       â”‚
â”‚   16                                                                                                                                                                                       â”‚
â”‚   17 # SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.                                                                                    â”‚
â”‚   18 # SPDX-License-Identifier: Apache-2.0                                                                                                                                                 â”‚
â”‚   19                                                                                                                                                                                       â”‚
â”‚   20 # Orchestrator runs on HOST (needs srun access), spawns containerized workers                                                                                                         â”‚
â”‚   21 # Config: /lustre/fsw/coreai_ai-foundation-models_dev/aflowers/srt-slurm/recipes/vllm/qwen3-32b/agg-round-robin.yaml                                                                  â”‚
â”‚   22 # Generated: 20260127_221142                                                                                                                                                          â”‚
â”‚   23                                                                                                                                                                                       â”‚
â”‚   24 set -e                                                                                                                                                                                â”‚
â”‚   25                                                                                                                                                                                       â”‚
â”‚   26 # Setup directories                                                                                                                                                                   â”‚
â”‚   27 SRTCTL_SOURCE="/lustre/fsw/coreai_ai-foundation-models_dev/aflowers/srt-slurm"                                                                                                        â”‚
â”‚   28 OUTPUT_BASE="/lustre/fsw/coreai_ai-foundation-models_dev/aflowers/srt-slurm/outputs"                                                                                                  â”‚
â”‚   29 OUTPUT_DIR="${OUTPUT_BASE}/${SLURM_JOB_ID}"                                                                                                                                           â”‚
â”‚   30 LOG_DIR="${OUTPUT_DIR}/logs"                                                                                                                                                          â”‚
â”‚   31 mkdir -p "${LOG_DIR}"                                                                                                                                                                 â”‚
â”‚   32                                                                                                                                                                                       â”‚
â”‚   33 # Export for Python orchestrator to use the same paths                                                                                                                                â”‚
â”‚   34 export SRTCTL_OUTPUT_DIR="${OUTPUT_DIR}"                                                                                                                                              â”‚
â”‚   35                                                                                                                                                                                       â”‚
â”‚   36 # Redirect stderr to stdout (SLURM captures both via --output)                                                                                                                        â”‚
â”‚   37 exec 2>&1                                                                                                                                                                             â”‚
â”‚   38                                                                                                                                                                                       â”‚
â”‚   39 echo "=========================================="                                                                                                                                     â”‚
â”‚   40 echo "ðŸš€ srtctl Sweep Orchestrator"                                                                                                                                                   â”‚
â”‚   41 echo "=========================================="                                                                                                                                     â”‚
â”‚   42 echo "Job ID: ${SLURM_JOB_ID}"                                                                                                                                                        â”‚
â”‚   43 echo "Config: /lustre/fsw/coreai_ai-foundation-models_dev/aflowers/srt-slurm/recipes/vllm/qwen3-32b/agg-round-robin.yaml"                                                             â”‚
â”‚   44 echo "Nodes: ${SLURM_JOB_NUM_NODES}"                                                                                                                                                  â”‚
â”‚   45 echo "Container: /lustre/fsw/coreai_ai-foundation-models_dev/aflowers/containers/nvidia+ai-dynamo+vllm-runtime+0.8.0.sqsh"                                                            â”‚
â”‚   46 echo "Start: $(date)"                                                                                                                                                                 â”‚
â”‚   47 echo "=========================================="                                                                                                                                     â”‚
â”‚   48 echo ""                                                                                                                                                                               â”‚
â”‚   49                                                                                                                                                                                       â”‚
â”‚   50 # Copy config to output directory                                                                                                                                                     â”‚
â”‚   51 cp "/lustre/fsw/coreai_ai-foundation-models_dev/aflowers/srt-slurm/recipes/vllm/qwen3-32b/agg-round-robin.yaml" "${OUTPUT_DIR}/config.yaml"                                           â”‚
â”‚   52                                                                                                                                                                                       â”‚
â”‚   53 # Get head node                                                                                                                                                                       â”‚
â”‚   54 HEAD_NODE=$(scontrol show hostnames ${SLURM_NODELIST} | head -n1)                                                                                                                     â”‚
â”‚   55 echo "Head node: ${HEAD_NODE}"                                                                                                                                                        â”‚
â”‚   56                                                                                                                                                                                       â”‚
â”‚   57 # Install srtctl using container's pip (host may not have pip)                                                                                                                        â”‚
â”‚   58 SRTCTL_INSTALL_DIR="${OUTPUT_DIR}/.srtctl_install"                                                                                                                                    â”‚
â”‚   59 mkdir -p "${SRTCTL_INSTALL_DIR}"                                                                                                                                                      â”‚
â”‚   60 export SRTCTL_SOURCE_DIR="${SRTCTL_SOURCE}"                                                                                                                                           â”‚
â”‚   61                                                                                                                                                                                       â”‚
â”‚   62 echo ""                                                                                                                                                                               â”‚
â”‚   63 echo "Installing srtctl dependencies via container..."                                                                                                                                â”‚
â”‚   64 srun --nodes=1 --ntasks=1 --nodelist="${HEAD_NODE}" \                                                                                                                                 â”‚
â”‚   65     --container-image="/lustre/fsw/coreai_ai-foundation-models_dev/aflowers/containers/nvidia+ai-dynamo+vllm-runtime+0.8.0.sqsh" \                                                    â”‚
â”‚   66     --container-mounts="${SRTCTL_SOURCE}:/srtctl-src,${SRTCTL_INSTALL_DIR}:/srtctl-install" \                                                                                         â”‚
â”‚   67     pip install --quiet --target=/srtctl-install /srtctl-src                                                                                                                          â”‚
â”‚   68                                                                                                                                                                                       â”‚
â”‚   69 export PYTHONPATH="${SRTCTL_INSTALL_DIR}:${PYTHONPATH}"                                                                                                                               â”‚
â”‚   70 echo "Installed to ${SRTCTL_INSTALL_DIR}"                                                                                                                                             â”‚
â”‚   71                                                                                                                                                                                       â”‚
â”‚   72                                                                                                                                                                                       â”‚
â”‚   73                                                                                                                                                                                       â”‚
â”‚   74 echo "Running orchestrator on host (with srun access)..."                                                                                                                             â”‚
â”‚   75 echo ""                                                                                                                                                                               â”‚
â”‚   76                                                                                                                                                                                       â”‚
â”‚   77 # Run orchestrator on the HOST (not in container) so it has access to srun                                                                                                            â”‚
â”‚   78 # The orchestrator will spawn containerized workers                                                                                                                                   â”‚
â”‚   79 # Output goes to SLURM's --output (sweep_%j.log)                                                                                                                                      â”‚
â”‚   80 set +e  # Temporarily disable exit-on-error to capture exit code                                                                                                                      â”‚
â”‚   81 python3 -u -m srtctl.cli.do_sweep "/lustre/fsw/coreai_ai-foundation-models_dev/aflowers/srt-slurm/recipes/vllm/qwen3-32b/agg-round-robin.yaml"                                        â”‚
â”‚   82 EXIT_CODE=$?                                                                                                                                                                          â”‚
â”‚   83 set -e  # Re-enable exit-on-error                                                                                                                                                     â”‚
â”‚   84                                                                                                                                                                                       â”‚
â”‚   85 echo ""                                                                                                                                                                               â”‚
â”‚   86 echo "=========================================="                                                                                                                                     â”‚
â”‚   87 if [ $EXIT_CODE -eq 0 ]; then                                                                                                                                                         â”‚
â”‚   88     echo "âœ“ Sweep completed successfully"                                                                                                                                             â”‚
â”‚   89 else                                                                                                                                                                                  â”‚
â”‚   90     echo "âœ— Sweep failed (exit code: $EXIT_CODE)"                                                                                                                                     â”‚
â”‚   91 fi                                                                                                                                                                                    â”‚
â”‚   92 echo "End: $(date)"                                                                                                                                                                   â”‚
â”‚   93 echo "=========================================="                                                                                                                                     â”‚
â”‚   94                                                                                                                                                                                       â”‚
â”‚   95 exit ${EXIT_CODE}                                                                                                                                                                     â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
