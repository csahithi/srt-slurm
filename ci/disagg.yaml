# Router benchmark - Disaggregated mode with Qwen 32B
#
# Router configuration notes for PD disaggregation:
# - Small scale (few replicas): round-robin is actually good enough
# - At scale (many replicas): use cache-aware routing on BOTH prefill and decode
#
# For dynamo frontend:
# - router-mode: kv enables cache-aware routing
# - The frontend auto-detects prefill workers and activates internal prefill router
# - Both prefill router and decode router use the same --router-mode setting
#
# For sglang-router (if using frontend.use_sglang_router: true):
#   Policies: random | round_robin | cache_aware | power_of_two | bucket
#   PD mode supports separate policies per stage:
#   sglang_router_args:
#     policy: cache_aware              # default policy
#     prefill-policy: cache_aware      # cache-aware for prefill (prefix reuse)
#     decode-policy: power_of_two      # load-aware for decode (balance generation load)
#     cache-threshold: 0.5             # cache hit threshold
#     balance-abs-threshold: 32        # absolute load diff before rebalancing

name: "router-bench-disagg-qwen32b"

model:
  path: "qwen32b"  # alias - configure in srtslurm.yaml
  container: "latest"
  precision: "fp8"

resources:
  gpu_type: "h100"
  prefill_nodes: 2
  decode_nodes: 2
  prefill_workers: 2
  decode_workers: 2
  gpus_per_node: 8

frontend:
  # Dynamo frontend with KV-aware routing
  # At scale, cache-aware on both prefill and decode is recommended
  dynamo_frontend_args:
    router-mode: kv
    router-reset-states: true

backend:
  sglang_config:
    # probably use flashattn 3 for attn backend
    prefill:
      disaggregation-mode: "prefill"
      served-model-name: "Qwen/Qwen2.5-32B-Instruct"
      model-path: "/model/"
      trust-remote-code: true
      tensor-parallel-size: 8
      mem-fraction-static: 0.90
      disaggregation-bootstrap-port: 30001

    decode:
      disaggregation-mode: "decode"
      served-model-name: "Qwen/Qwen2.5-32B-Instruct"
      model-path: "/model/"
      trust-remote-code: true
      tensor-parallel-size: 8
      mem-fraction-static: 0.90
      disaggregation-bootstrap-port: 30001

benchmark:
  type: "router"
