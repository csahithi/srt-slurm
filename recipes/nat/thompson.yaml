# NeMo Agent Toolkit + Dynamo with Thompson Sampling Router (srtslurm)
# Uses custom Dynamo frontend, router, and processor for KV-aware routing.
#
# Prerequisites:
#   - Network access to clone NeMo-Agent-Toolkit repo (setup script handles this)
#
# The setup script clones NeMo-Agent-Toolkit, installs NAT, and links custom Dynamo components.
name: "nemo-dynamo-thompson"

model:
  path: "qwen32b"
  container: "lmsysorg/sglang:v0.5.8"
  precision: "bf16"

resources:
  gpu_type: "gb200"
  gpus_per_node: 4
  agg_nodes: 1
  agg_workers: 4

# Setup script clones NAT repo and links custom Dynamo components
# Override repo/branch via NAT_REPO and NAT_BRANCH env vars
setup_script: "nat-setup.sh"

# Custom Dynamo components via sidecars
sidecars:
  router:
    # Thompson Sampling router with KV overlap awareness
    command: >
      python3 /workspace/custom_dynamo/router.py
      --block-size 64
      --router-type kv
      --affinity-base 0.30
      --temp-base 1.0
      --lints-lambda 1.0
    env:
      ROUTER_METRICS_CSV: "/logs/router_metrics.csv"

  processor:
    command: "python3 /workspace/custom_dynamo/processor.py --model /model --enable-router"
    env:
      PROCESSOR_METRICS_CSV: "/logs/processor_requests.csv"

frontend:
  # Custom frontend with prefix hints support
  type: custom
  command: "python3 /workspace/custom_dynamo/frontend.py"
  env:
    FRONTEND_MODEL_MAPPING: '{"qwen32b": "/model"}'
    FRONTEND_TPS_INTERVAL: "5"
    FRONTEND_TPS_CSV: "/logs/frontend_throughput.csv"

backend:
  type: sglang
  sglang_config:
    aggregated:
      tp: 1
      served-model-name: "qwen32b"
      trust-remote-code: true
      json-model-override-args: '{"rope_scaling":{"rope_type":"yarn","factor":4.0,"original_max_position_embeddings":32768},"max_position_embeddings":131072}'
      context-length: 131072
      page-size: 64
      mem-fraction-static: 0.9
      enable-metrics: true

benchmark:
  type: custom
  # NAT is cloned and installed in a venv using uv (avoids system package conflicts)
  command: |
    pip install uv &&
    git clone --depth 1 https://github.com/NVIDIA/NeMo-Agent-Toolkit.git /workspace/NeMo-Agent-Toolkit &&
    uv venv --clear /workspace/nat-venv &&
    source /workspace/nat-venv/bin/activate &&
    uv pip install /workspace/NeMo-Agent-Toolkit/packages/nvidia_nat_core &&
    uv pip install /workspace/NeMo-Agent-Toolkit/packages/nvidia_nat_langchain &&
    uv pip install /workspace/NeMo-Agent-Toolkit &&
    uv pip install /workspace/NeMo-Agent-Toolkit/examples/dynamo_integration/react_benchmark_agent &&
    python3 /workspace/NeMo-Agent-Toolkit/examples/dynamo_integration/scripts/download_agent_leaderboard_v2.py &&
    python3 /workspace/NeMo-Agent-Toolkit/examples/dynamo_integration/scripts/create_test_subset.py &&
    cd /workspace/NeMo-Agent-Toolkit &&
    nat eval --config_file examples/dynamo_integration/react_benchmark_agent/src/react_benchmark_agent/configs/eval_config_no_rethinking_minimal_test.yml
