# SGLang Router Mode Example Configuration
# This configuration uses sglang_router.launch_router instead of the dynamo stack
# Useful for expert distribution recording and custom routing

name: "sglang-router-example"

model:
  path: "/models/deepseek-r1"
  container: "/containers/sglang.sqsh"
  precision: "fp8"

resources:
  gpu_type: "gb200"
  prefill_nodes: 1
  decode_nodes: 1
  prefill_workers: 1
  decode_workers: 1
  gpus_per_node: 4

backend:
  # Enable sglang_router mode - uses sglang.launch_server for workers
  # and sglang_router.launch_router instead of dynamo.frontend
  use_sglang_router: true

  # Prefill-specific environment variables
  prefill_environment:
    PYTHONUNBUFFERED: "1"
    SGLANG_DISAGGREGATION_HEARTBEAT_MAX_FAILURE: "100000"
    SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT: "100000"
    SGLANG_DISAGGREGATION_WAITING_TIMEOUT: "100000"

  # Decode-specific environment variables
  decode_environment:
    PYTHONUNBUFFERED: "1"
    SGLANG_DISAGGREGATION_HEARTBEAT_MAX_FAILURE: "100000"
    SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT: "100000"
    SGLANG_DISAGGREGATION_WAITING_TIMEOUT: "100000"

  sglang_config:
    prefill:
      # Model configuration
      served_model_name: "deepseek-ai/DeepSeek-R1"
      model_path: "/model/"
      trust_remote_code: true

      # KV cache and attention
      kv_cache_dtype: "fp8_e4m3"
      attention_backend: "trtllm_mla"

      # Quantization
      quantization: "fp8"
      moe_runner_backend: "flashinfer_trtllm"

      # Disaggregation
      disaggregation_mode: "prefill"
      disaggregation_bootstrap_port: 30001

      # Parallelism
      tp_size: 4
      dp_size: 1
      ep_size: 4

      # Memory and tokens
      mem_fraction_static: 0.85
      max_total_tokens: 8192
      chunked_prefill_size: 8192
      max_running_requests: 512

      # Other settings
      disable_radix_cache: true
      stream_interval: 10
      watchdog_timeout: 1000000
      context_length: 2200

    decode:
      # Model configuration
      served_model_name: "deepseek-ai/DeepSeek-R1"
      model_path: "/model/"
      trust_remote_code: true

      # KV cache and attention
      kv_cache_dtype: "fp8_e4m3"
      attention_backend: "trtllm_mla"

      # Quantization
      quantization: "fp8"
      moe_runner_backend: "flashinfer_trtllm"

      # Disaggregation
      disaggregation_mode: "decode"
      disaggregation_bootstrap_port: 30001

      # Parallelism
      tp_size: 4
      dp_size: 1
      ep_size: 4

      # Memory and tokens
      mem_fraction_static: 0.85
      chunked_prefill_size: 8192
      max_running_requests: 512

      # Other settings
      disable_radix_cache: true
      stream_interval: 10
      watchdog_timeout: 1000000
      context_length: 2200
      prefill_round_robin_balance: true

benchmark:
  type: "manual"  # No automatic benchmarking

# Notes:
# - sglang_router mode uses sglang.launch_server for workers (not dynamo.sglang)
# - Router is launched on the first prefill node on port 8000
# - Router connects to all prefill and decode worker leaders
# - Workers expose ports 30000 (prefill) and 30001 (decode)
# - Bootstrap port 30001 is used for prefill workers only
# - This mode is useful for expert distribution recording and custom routing logic
